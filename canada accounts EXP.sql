WITH		
parents as (		
   SELECT ID AS AGENT_PARENTID, CUSTOM_CUSTOMERNAME,  AGENT_INSTANCECATEGORY, AGENT_INSTANCETYPE ,          		
    CUSTOM_TR_MARKET_SEGMENT_L_1,CUSTOM_TR_MARKET_SEGMENT_L_2, CUSTOM_COUNTRY		
    FROM PROD.SOURCE.PENDO_HIGHQ_ACCOUNT_HISTORY_VW		
    WHERE ID IS NOT NULL and ID not like '%[a-z]%' 		
    --AND CUSTOM_TR_MARKET_SEGMENT_L_1 LIKE  'Corporate'		
    AND AGENT_INSTANCECATEGORY LIKE 'Client' AND AGENT_INSTANCETYPE LIKE 'Live'		
    --AND CUSTOM_COUNTRY like 'CA'
    AND ID IN
    (
     '1434230376442',
'1510734051470',
'1521539254130',
'1594303185547',
'1652099128133',
'1528888013707',
'1720767396283',
'1478690539260',
'1547634795290',
'1632215998767',
'1627981170553',
'1671623236697',
'1599122264640',
'1439068239718',
'1499852242617',
'1659441127380',
'1698218969390',
'1631623738440',
'1673612601067',
'1605106117363',
'1572618700510',
'1642158137493',
'1648637385280',
'1690792750680',
'1610703401897',
'1659009851283',
'1630405380277',
'1654685736727',
'1445331912633',
'1700027571833',
'1664885300130',
'1680787055303',
'1614615139717'
    )
    QUALIFY RANK() OVER (PARTITION BY ID ORDER BY LAST_UPDATED_AT DESC)= 1 		
    
)
,ACCOUNTS_1 AS (		
    SELECT ID AS ACCOUNTID
    --, AGENT_PARENTID, AGENT_SITEPURPOSE ,AGENT_ISSITETEMPLATE,LAST_UPDATED_AT		
		
    FROM PROD.SOURCE.PENDO_HIGHQ_ACCOUNT_HISTORY_VW		
    WHERE ID IS NOT NULL and ID not like '%[a-z]%' 		
    --AND CONTAINS(lower(AGENT_SITEPURPOSE),'client portal')		
    --AND AGENT_SITEPURPOSE LIKE 'Contract Management'		
    AND AGENT_PARENTID IN (SELECT AGENT_PARENTID FROM parents) 		
    QUALIFY RANK() OVER (PARTITION BY ID ORDER BY LAST_UPDATED_AT DESC)= 1 		
)

select * from ACCOUNTS_1